#------------------------------------------------------------------------------
# GitHub Actions Workflow – Build & Publish Saltcorn OCI Images
#
# Behaviour is driven entirely by `.ci/build-matrix.yml`; edit that file to
# add/remove Node or Saltcorn versions.
#
# ──────────────────────────────────────────────────────────────────────────────
# Author:  Troy Kelly <troy@team.production.city>
# History:
#   2025-04-30 • Initial scaffold
#   2025-04-30 • “act” compatibility – emit single-line matrix JSON
#------------------------------------------------------------------------------

name: Build & Publish Saltcorn Containers

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * 1'   # 02:00 UTC every Monday – weekly rebuild

permissions:
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository_owner }}/saltcorn

jobs:

  #─────────────────────────────────────────────────────────────────────────────
  # 1. Matrix generation – read YAML & output JSON build matrix
  #─────────────────────────────────────────────────────────────────────────────
  matrix:
    name: Generate build matrix
    runs-on: ubuntu-latest

    outputs:
      matrix:        ${{ steps.generate.outputs.matrix }}
      default_node:  ${{ steps.generate.outputs.default_node }}
      default_sc:    ${{ steps.generate.outputs.default_sc }}
      edge_sc:       ${{ steps.generate.outputs.edge_sc }}

    steps:
      - name: ⤵️  Checkout source
        uses: actions/checkout@v4

      - name: 🛠️  Install yq (Go-based, mikefarah/yq)
        run: |
          YQ_VERSION="v4.45.1"
          sudo wget -q https://github.com/mikefarah/yq/releases/download/${YQ_VERSION}/yq_linux_amd64 -O /usr/local/bin/yq
          sudo chmod +x /usr/local/bin/yq

      - name: 🔄  Generate matrix JSON & expose defaults
        id: generate
        shell: bash
        run: |
          set -euo pipefail
          CONFIG=".ci/build-matrix.yml"

          default_node=$(yq '.node.default'   < "$CONFIG")
          default_sc=$(yq '.saltcorn.default' < "$CONFIG")
          edge_sc=$(yq '.saltcorn.edge'       < "$CONFIG")

          # Build flat cross-product (Node × Saltcorn) then compact to one line
          matrix_json=$(yq -o=json '
            . as $root
            | [ $root.node.versions[] as $node
              | $root.saltcorn.versions[] as $sc
              | { "node": $node, "saltcorn": $sc } ]
          ' "$CONFIG" | jq -c '.')

          echo "🔍 Generated build matrix:"
          echo "${matrix_json}" | jq '.'

          {
            echo "default_node=${default_node}"
            echo "default_sc=${default_sc}"
            echo "edge_sc=${edge_sc}"
            echo "matrix=${matrix_json}"
          } >>"$GITHUB_OUTPUT"

  #─────────────────────────────────────────────────────────────────────────────
  # 2. Build & (optionally) push images for every matrix entry
  #─────────────────────────────────────────────────────────────────────────────
  build:
    name: Build & Push – ${{ matrix.node }} / ${{ matrix.saltcorn }}
    needs: matrix
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.matrix.outputs.matrix) }}

    steps:
      - name: ⤵️  Checkout source
        uses: actions/checkout@v4

      #── Docker buildx & QEMU for multi-arch support ─────────────────────────
      - name: 🏗️  Set-up QEMU (cross-arch emulation)
        uses: docker/setup-qemu-action@v3

      - name: 🏗️  Set-up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          install: true
          provenance: true
          sbom: true
          driver-opts: env.BUILDKIT_INLINE_CACHE=1

      #── Registry login (GHCR) ───────────────────────────────────────────────
      - name: 🔐  Log-in to GHCR
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      #── Record build timestamp for OCI label ───────────────────────────────
      - name: ℹ️  Capture build timestamp
        id: meta
        run: echo "created=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >>"$GITHUB_OUTPUT"

      #── Generate full tag list for this permutation ─────────────────────────
      - name: 🏷️  Calculate tags
        id: tags
        shell: bash
        env:
          NODE_TAG:     ${{ matrix.node }}
          SC_VERSION:   ${{ matrix.saltcorn }}
          DEFAULT_NODE: ${{ needs.matrix.outputs.default_node }}
          DEFAULT_SC:   ${{ needs.matrix.outputs.default_sc }}
          EDGE_SC:      ${{ needs.matrix.outputs.edge_sc }}
          REGISTRY:     ${{ env.REGISTRY }}
          IMAGE_NAME:   ${{ env.IMAGE_NAME }}
        run: |
          set -euo pipefail
          declare -a TAGS

          # Base tag (always present) – includes explicit Node variant
          TAGS+=("${REGISTRY}/${IMAGE_NAME}:${SC_VERSION}-${NODE_TAG}")

          # Extra tags only on the *default* Node base
          if [[ "${NODE_TAG}" == "${DEFAULT_NODE}" ]]; then
            TAGS+=("${REGISTRY}/${IMAGE_NAME}:${SC_VERSION}")

            # SemVer truncations for stable releases
            if [[ "${SC_VERSION}" =~ ^([0-9]+)\.([0-9]+)\.([0-9]+)$ ]]; then
              major="${BASH_REMATCH[1]}"
              minor="${BASH_REMATCH[2]}"
              TAGS+=("${REGISTRY}/${IMAGE_NAME}:${major}.${minor}")
              TAGS+=("${REGISTRY}/${IMAGE_NAME}:${major}")
            fi

            [[ "${SC_VERSION}" == "${DEFAULT_SC}" ]] && TAGS+=("${REGISTRY}/${IMAGE_NAME}:latest")
            [[ "${SC_VERSION}" == "${EDGE_SC}"    ]] && TAGS+=("${REGISTRY}/${IMAGE_NAME}:edge")
          fi

          printf '%s\n' "${TAGS[@]}"

          { echo 'list<<EOF'; printf '%s\n' "${TAGS[@]}"; echo 'EOF'; } >>"$GITHUB_OUTPUT"

      #── Build & (optionally) push image ─────────────────────────────────────
      - name: 🐳  Build (and push if applicable)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: containers/Dockerfile.saltcorn
          platforms: linux/amd64,linux/arm64
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.tags.outputs.list }}
          build-args: |
            NODE_BASE=${{ matrix.node }}
            SALTCORN_VERSION=${{ matrix.saltcorn }}
          labels: |
            org.opencontainers.image.title=Saltcorn
            org.opencontainers.image.description=Saltcorn – Low-code platform packaged by Production City
            org.opencontainers.image.version=${{ matrix.saltcorn }}
            org.opencontainers.image.url=https://saltcorn.com/
            org.opencontainers.image.source=https://github.com/${{ github.repository }}
            org.opencontainers.image.licenses=MIT
            org.opencontainers.image.created=${{ steps.meta.outputs.created }}
            org.opencontainers.image.authors=Troy Kelly <troy@team.production.city>
            org.opencontainers.image.vendor=Production City
            org.opencontainers.image.documentation=https://github.com/${{ github.repository }}/blob/${{ github.sha }}/README.md
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.ref.name=${{ github.ref }}
            org.opencontainers.image.base.name=node:${{ matrix.node }}
            # Legacy label-schema duplicates
            org.label-schema.name=Saltcorn
            org.label-schema.vcs-url=https://github.com/${{ github.repository }}
            org.label-schema.vcs-ref=${{ github.sha }}
            org.label-schema.schema-version=1.0
          provenance: true
          sbom: true